from telegram import Bot
from keys import TELEGRAM_BOT_TOKEN, CHAT_ID
import random
import asyncio
from analytics import get_most_popular_topic, load_reaction_data

bot = Bot(token=TELEGRAM_BOT_TOKEN)

# ‚úÖ –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ–ø—Ä–æ—Å—ã (–±–æ—Ç –≤—ã–±–∏—Ä–∞–µ—Ç —Ç–µ–º—É, –∫–æ—Ç–æ—Ä–∞—è –Ω—Ä–∞–≤–∏—Ç—Å—è –ø–æ–¥–ø–∏—Å—á–∏–∫–∞–º)
async def send_poll():
    """üìä –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –æ–ø—Ä–æ—Å–∞ –≤ –∫–∞–Ω–∞–ª"""
    topic = get_most_popular_topic()  # ‚úÖ –ü–æ–ª—É—á–∞–µ–º —Å–∞–º—É—é –ø–æ–ø—É–ª—è—Ä–Ω—É—é —Ç–µ–º—É
    question = f"–ö–∞–∫—É—é —Ç–µ–º—É —Ç—ã —Ö–æ—á–µ—à—å –≤–∏–¥–µ—Ç—å —á–∞—â–µ?"
    options = ["–°–ø–æ—Ä—Ç", "–ü—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—å", "–ë–∏–æ—Ö–∞–∫–∏–Ω–≥", "–ó–¥–æ—Ä–æ–≤—å–µ"]

    # ‚úÖ –ï—Å–ª–∏ –±–æ—Ç –≤–∏–¥–∏—Ç, —á—Ç–æ –ø–æ–¥–ø–∏—Å—á–∏–∫–∏ –±–æ–ª—å—à–µ –ª–∞–π–∫–∞—é—Ç –ø–æ—Å—Ç—ã –ø—Ä–æ —Å–ø–æ—Ä—Ç, –æ–Ω –ø–æ–¥–±–∏—Ä–∞–µ—Ç —Å–ø–æ—Ä—Ç-—Ç–µ–º–∞—Ç–∏–∫—É
    if "—Å–ø–æ—Ä—Ç" in topic.lower():
        question = "–ö–∞–∫–æ–π –≤–∏–¥ —Å–ø–æ—Ä—Ç–∞ —Ç–µ–±–µ –∏–Ω—Ç–µ—Ä–µ—Å–µ–Ω –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ?"
        options = ["–ë–µ–≥", "–§–∏—Ç–Ω–µ—Å", "–ü–ª–∞–≤–∞–Ω–∏–µ", "–ô–æ–≥–∞"]

    try:
        await bot.send_poll(chat_id=CHAT_ID, question=question, options=options)
        await asyncio.sleep(5)
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –æ–ø—Ä–æ—Å–∞: {e}")


# ‚úÖ –í–∏–∫—Ç–æ—Ä–∏–Ω—ã —Å —Ä–∞–∑–Ω—ã–º–∏ —É—Ä–æ–≤–Ω—è–º–∏ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
async def send_quiz():
    """üß† –û—Ç–ø—Ä–∞–≤–∫–∞ –≤–∏–∫—Ç–æ—Ä–∏–Ω—ã –≤ –∫–∞–Ω–∞–ª (–¢–µ–ø–µ—Ä—å –≤—Å–µ–≥–¥–∞ –∞–Ω–æ–Ω–∏–º–Ω–æ)"""
    reaction_data = load_reaction_data()  # –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ —Ä–µ–∞–∫—Ü–∏—è—Ö

    # ‚úÖ –§–∏–ª—å—Ç—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ, —á—Ç–æ–±—ã —É–±—Ä–∞—Ç—å –≤–æ–∑–º–æ–∂–Ω—ã–µ —Å–ø–∏—Å–∫–∏ (–±–µ—Ä—ë–º —Ç–æ–ª—å–∫–æ int)
    total_reactions = sum(
        sum(value for value in topic.values() if isinstance(value, int))
        for topic in reaction_data.values()
    )

    # –ï—Å–ª–∏ –ø–æ–¥–ø–∏—Å—á–∏–∫–∏ –∞–∫—Ç–∏–≤–Ω–æ —Ä–µ–∞–≥–∏—Ä—É—é—Ç, –¥–∞—ë–º —Å–ª–æ–∂–Ω—ã–π –≤–æ–ø—Ä–æ—Å
    if total_reactions > 100:
        question = "–ö–∞–∫–æ–π —ç–ª–µ–º–µ–Ω—Ç –ø–∏—Ç–∞–Ω–∏—è –¥–∞—ë—Ç –Ω–∞–∏–±–æ–ª—å—à—É—é —ç–Ω–µ—Ä–≥–∏—é?"
        options = ["–ë–µ–ª–∫–∏", "–ñ–∏—Ä—ã", "–£–≥–ª–µ–≤–æ–¥—ã", "–ú–∏–Ω–µ—Ä–∞–ª—ã"]
        correct_option_id = 2  # ‚úÖ "–£–≥–ª–µ–≤–æ–¥—ã"

    else:
        question = "–ö–∞–∫–æ–π –ø—Ä–æ–¥—É–∫—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ –≤–∏—Ç–∞–º–∏–Ω–∞ C?"
        options = ["–õ–∏–º–æ–Ω", "–ö–∏–≤–∏", "–ü–µ—Ä–µ—Ü", "–ê–ø–µ–ª—å—Å–∏–Ω"]
        correct_option_id = 1  # ‚úÖ "–ö–∏–≤–∏"

    try:
        await bot.send_poll(
            chat_id=CHAT_ID,
            question=question,
            options=options,
            type="quiz",
            correct_option_id=correct_option_id,
            is_anonymous=True  # ‚úÖ –¢–µ–ø–µ—Ä—å –æ–ø—Ä–æ—Å –≤—Å–µ–≥–¥–∞ –∞–Ω–æ–Ω–∏–º–Ω—ã–π (—á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –æ—à–∏–±–∫–∏)
        )
        await asyncio.sleep(5)
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –≤–∏–∫—Ç–æ—Ä–∏–Ω—ã: {e}")




# ‚úÖ –£–ª—É—á—à–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —á–µ–ª–ª–µ–Ω–¥–∂–µ–π —Å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è–º–∏
active_challenge = None  # –•—Ä–∞–Ω–∏–º –∞–∫—Ç–∏–≤–Ω—ã–π —á–µ–ª–ª–µ–Ω–¥–∂

async def send_challenge_day():
    """üî• –û—Ç–ø—Ä–∞–≤–∫–∞ —á–µ–ª–ª–µ–Ω–¥–∂–∞ –¥–Ω—è + –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ, –µ—Å–ª–∏ –æ–Ω –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω"""
    global active_challenge
    challenges = [
        "üí™ –î–µ–Ω—å 1: 50 –ø—Ä–∏—Å–µ–¥–∞–Ω–∏–π",
        "üèÉ –î–µ–Ω—å 2: 10 –º–∏–Ω—É—Ç –±–µ–≥–∞",
        "üìñ –î–µ–Ω—å 3: –ü—Ä–æ—á–∏—Ç–∞—Ç—å 5 —Å—Ç—Ä–∞–Ω–∏—Ü –∫–Ω–∏–≥–∏",
        "üíß –î–µ–Ω—å 4: –í—ã–ø–∏—Ç—å 2 –ª–∏—Ç—Ä–∞ –≤–æ–¥—ã",
        "üßò –î–µ–Ω—å 5: 5 –º–∏–Ω—É—Ç –º–µ–¥–∏—Ç–∞—Ü–∏–∏"
    ]

    # ‚úÖ –ï—Å–ª–∏ —á–µ–ª–ª–µ–Ω–¥–∂ —É–∂–µ –±—ã–ª –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∏ –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω ‚Äì –Ω–∞–ø–æ–º–∏–Ω–∞–µ–º –æ –Ω—ë–º
    if active_challenge:
        try:
            await bot.send_message(chat_id=CHAT_ID, text=f"‚è≥ –ù–µ –∑–∞–±—ã–≤–∞–π –ø—Ä–æ —Ç–µ–∫—É—â–∏–π —á–µ–ª–ª–µ–Ω–¥–∂: {active_challenge}")
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ —á–µ–ª–ª–µ–Ω–¥–∂–µ: {e}")
        return  # –ù–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π —á–µ–ª–ª–µ–Ω–¥–∂

    active_challenge = random.choice(challenges)

    try:
        await bot.send_message(chat_id=CHAT_ID, text=f"üî• –ß–µ–ª–ª–µ–Ω–¥–∂ –¥–Ω—è: {active_challenge}")
        await asyncio.sleep(5)
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —á–µ–ª–ª–µ–Ω–¥–∂–∞: {e}")


# ‚úÖ –ò—Ç–æ–≥ –Ω–µ–¥–µ–ª–∏ —Å –∞–Ω–∞–ª–∏–∑–æ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤
async def send_weekly_summary():
    """üìÖ –ü–æ–¥–≤–µ–¥–µ–Ω–∏–µ –∏—Ç–æ–≥–æ–≤ –Ω–µ–¥–µ–ª–∏ —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏"""
    reaction_data = load_reaction_data()
    most_liked_topic = max(reaction_data, key=lambda topic: reaction_data[topic]["total_likes"], default="–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö")

    summary_text = (
        "üìù –ò—Ç–æ–≥–∏ –Ω–µ–¥–µ–ª–∏:\n"
        f"‚úî –°–∞–º–∞—è –ø–æ–ø—É–ª—è—Ä–Ω–∞—è —Ç–µ–º–∞: {most_liked_topic}\n"
        f"üî• –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∞–∫—Ü–∏–π: {sum(topic['total_likes'] for topic in reaction_data.values())}\n"
        f"üèÜ –õ—É—á—à–∏–π –ø–æ–¥–ø–∏—Å—á–∏–∫: @username (–ø–æ –ª–∞–π–∫–∞–º)"
    )

    try:
        await bot.send_message(chat_id=CHAT_ID, text=summary_text)
        await asyncio.sleep(5)
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –Ω–µ–¥–µ–ª—å–Ω–æ–≥–æ –æ—Ç—á—ë—Ç–∞: {e}")


# ‚úÖ –û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å —Å –ø–æ–¥–ø–∏—Å—á–∏–∫–∞–º–∏ (—Ç–µ–ø–µ—Ä—å –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏—Ö –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π)
async def send_feedback_request():
    """üí¨ –ó–∞–ø—Ä–æ—Å –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤"""
    topic = get_most_popular_topic()
    feedback_text = f"üí¨ –ß—Ç–æ –≤–∞–º –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ –ø–æ–Ω—Ä–∞–≤–∏–ª–æ—Å—å –≤ –ø–æ—Å—Ç–∞—Ö –ø—Ä–æ {topic}? –ù–∞–ø–∏—à–∏—Ç–µ –Ω–∞–º!"

    try:
        await bot.send_message(chat_id=CHAT_ID, text=feedback_text)
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏: {e}")
