import random
import openai
from keys import OPENAI_API_KEY
from topics import topics  # –ò–º–ø–æ—Ä—Ç —Å–ø–∏—Å–∫–∞ —Ç–µ–º

# ‚úÖ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º API-–∫–ª—é—á –¥–ª—è OpenAI
openai.api_key = OPENAI_API_KEY

# ‚úÖ –•—Ä–∞–Ω–∏–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ —Ç–µ–º—ã, —á—Ç–æ–±—ã –Ω–µ –ø–æ–≤—Ç–æ—Ä—è–ª–∏—Å—å –ø–æ–¥—Ä—è–¥
used_topics = []

def get_next_topic():
    """üìå –í—ã–±–æ—Ä —Å–ª–µ–¥—É—é—â–µ–π —Ç–µ–º—ã, –∏—Å–∫–ª—é—á–∞—è —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ."""
    global used_topics
    if len(used_topics) == len(topics):
        used_topics = []  # –ï—Å–ª–∏ –≤—Å–µ —Ç–µ–º—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω—ã, –æ—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫

    available_topics = [topic for topic in topics if topic not in used_topics]
    next_topic = random.choice(available_topics)
    used_topics.append(next_topic)
    return next_topic


def generate_post(topic=None):
    """‚úçÔ∏è –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞ –ø–æ—Å—Ç–∞ —á–µ—Ä–µ–∑ OpenAI GPT-4."""

    if topic is None:
        topic = get_next_topic()

    prompt = (
        f"–ù–∞–ø–∏—à–∏ –≤–¥–æ—Ö–Ω–æ–≤–ª—è—é—â–∏–π, —É–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω—ã–π –∏ –ª–µ–≥–∫–æ —á–∏—Ç–∞–µ–º—ã–π –ø–æ—Å—Ç –Ω–∞ —Ç–µ–º—É: \"{topic}\". "
        "–¢–µ–∫—Å—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≥—Ä–∞–º–æ—Ç–Ω—ã–º –∏ –ª–æ–≥–∏—á–Ω—ã–º, –±–µ–∑ –æ—à–∏–±–æ–∫, —Å–æ–¥–µ—Ä–∂–∞—Ç–µ–ª—å–Ω—ã–º –∏ –ø–æ–ª–µ–∑–Ω—ã–º. "
        "–î–æ–±–∞–≤—å –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–µ —Ñ–∞–∫—Ç—ã, –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã, –ø–æ–ª–µ–∑–Ω—ã–µ –≤—ã–≤–æ–¥—ã –∏ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–µ –æ—Ç–∫—Ä—ã—Ç–∏—è. "
        "–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É–π —Ç–µ–∫—Å—Ç —Å –∞–±–∑–∞—Ü–∞–º–∏ –∏ —Å–ø–∏—Å–∫–∞–º–∏, —á—Ç–æ–±—ã –æ–Ω –±—ã–ª –ª—ë–≥–∫–∏–º –¥–ª—è —á—Ç–µ–Ω–∏—è. "
        "–ò—Å–ø–æ–ª—å–∑—É–π –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π, –Ω–æ —Å–µ—Ä—å—ë–∑–Ω—ã–π —Ç–æ–Ω. "
        "–î–æ–±–∞–≤—å –Ω–µ–º–Ω–æ–≥–æ —ç–º–æ–¥–∑–∏, —á—Ç–æ–±—ã —Ç–µ–∫—Å—Ç –≤—ã–≥–ª—è–¥–µ–ª –∂–∏–≤—ã–º, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω–∏ –ø–æ–¥—á—ë—Ä–∫–∏–≤–∞—é—Ç —Å–º—ã—Å–ª —Ç–µ–∫—Å—Ç–∞."
        "–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É–π –º–∞—Ç–µ—Ä–∏–∞–ª –≤ –≤–∏–¥–µ —Å–ø–∏—Å–∫–æ–≤, –Ω–æ –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞–π –≤–∏–∑—É–∞–ª—å–Ω—ã–º–∏ —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏. "
        "–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ: –Ω–µ –±–æ–ª—å—à–µ 2000 —Å–∏–º–≤–æ–ª–æ–≤."
    )

    try:
        response = openai.ChatCompletion.create(
            model="gpt-3.5-turbo",
            messages=[{"role": "system", "content": prompt}],
            timeout=30  # ‚úÖ –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è OpenAI API
        )
        return response["choices"][0]["message"]["content"].strip()

    except openai.error.Timeout:
        print("‚è≥ OpenAI API —Å–ª–∏—à–∫–æ–º –¥–æ–ª–≥–æ –æ—Ç–≤–µ—á–∞–µ—Ç. –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —ç—Ç–æ—Ç –∑–∞–ø—Ä–æ—Å.")
        return "–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–æ—Å—Ç–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."

    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–µ–∫—Å—Ç–∞ —á–µ—Ä–µ–∑ OpenAI: {e}")
        return "–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–æ—Å—Ç–∞."


def split_text_by_paragraphs(text, max_length=1024):
    """‚úÇÔ∏è –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –Ω–∞ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –æ—Å–Ω–æ–≤–Ω—É—é —á–∞—Å—Ç—å —Å —É—á—ë—Ç–æ–º –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –¥–ª–∏–Ω—ã."""
    paragraphs = text.split('\n')  # –†–∞–∑–¥–µ–ª—è–µ–º —Ç–µ–∫—Å—Ç –ø–æ –∞–±–∑–∞—Ü–∞–º
    if not paragraphs:
        return "", [""]  # –ï—Å–ª–∏ –Ω–µ—Ç —Ç–µ–∫—Å—Ç–∞, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è

    title = paragraphs[0]  # üèÜ –ü–µ—Ä–≤—ã–π –∞–±–∑–∞—Ü ‚Äî –∑–∞–≥–æ–ª–æ–≤–æ–∫
    body = "\n".join(paragraphs[1:]).strip()  # –û—Å—Ç–∞–ª—å–Ω–æ–π —Ç–µ–∫—Å—Ç

    # üîπ –†–∞–∑–±–∏–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω—É—é —á–∞—Å—Ç—å –Ω–∞ –±–ª–æ–∫–∏ (–ø–æ 1024 —Å–∏–º–≤–æ–ª–∞)
    messages = []
    current_message = ""

    for paragraph in body.split('\n'):
        if len(current_message) + len(paragraph) + 1 <= max_length:
            current_message += (paragraph + "\n")
        else:
            messages.append(current_message.strip())
            current_message = paragraph + "\n"

    # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –∫—É—Å–æ–∫ —Ç–µ–∫—Å—Ç–∞
    if current_message.strip():
        messages.append(current_message.strip())

    return title, messages  # ‚úÖ –ó–∞–≥–æ–ª–æ–≤–æ–∫ + —Å–ø–∏—Å–æ–∫ —á–∞—Å—Ç–µ–π –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
